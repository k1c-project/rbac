# Библиотека управления доступом на основе ролей
Библиотека, реализующая Role Based Access Control (RBAC), аналогично [Azure RBAC](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview).

## Описание

### Подсистемы
Библиотека оформлена в виде двух подсистем:

- _УправлениеДоступомRBAC_ - реализует необходимый функционал.
- _УправлениеДоступомRBACПользовательскийИнтерфейс_ - реализует отображение в пользовательском интерфейсе.

### Субъекты

Сущность субъект представлена справочниками __ПользовательRBAC__ и __ГруппаRBAC__. Пользователь текущего сеанса представлен параметроом сеанса __ТекущийПользовательRBAC__, который должен устанавливаться в конечном прикладном решении.

Группы RBAC не поддерживают вложенность.

### Роли RBAC
Сущность _Роль RBAC_, представлена справочником __РолиRBAC__, а также регистрами сведений __РазрешенияРолейRBAC__, __ИсключенияРазрешенийРолейRBAC__ и __ЗапретыРазрешенийРолейRBAC__.

Разрешения роли представлены регистром сведений __РазрешенияРолейRBAC__. Каждое разрешение (строка регистра ) включает в себя роль (справочник __РолиRBAC__), тип ресурса, к которому предоставляется доступ (справочник __ТипыРесурсовRBAC__), который имеет иерархическую структуру вида `ПровайдерРесурсов/ТипРесурса/Действие`, а также вид разрешения, который возможен для данного типа ресурса (справочник __ВидыРазрешенийRBAC__), который имеет нижеследующие предопределенные элементы:
- _Все_ - все разрешения;
- _Чтение_ - право на чтение объекта;
- _Запись_ - право на создание/изменение объекта;
- _Удаление_ - право на удаление объекта;
- _Действие_ - право на выполнение определенного действия.

Регистры __ИсключенияРазрешенийРолейRBAC__ и __ЗапретыРазрешенийРолейRBAC__ устроены аналогичным образом.

Запреты имеют преимущество над разрешениями, а исключения могут быть переопределены на нижеследующих уровнях иерархии объектов.

### Объекты
В качестве объекта доступа может выступать ссылочный объект конфигурации  любого типа. Для определения типа объекта используется общий реквизит __ТипРесурсаRBAC__, имеющий тип _СправочникСсылка.ТипыРесурсовRBAC_.

Иерархия объектов доступа строится автоматически на основе сведений о родителе и владельце объекта. Для реализации иерархии используется общий реквизит __РодительскийОбъектRBAC__, типа _ОпределяемыйТип.СсылкаОбъектRBAC_, в состав которого входят необходимые типы объектов.

### Назначение ролей

Функционал назначения ролей представлен регистром сведений __НазначениеРолейRBAC__, каждая запись которого содержит субъект, роль, а также объект, которому назначена роль. 

### Организация проверки доступа

Проверка доступа осуществляется при помощи подписок на события __ОбъектRBAC_ПередЗаписью__ и __ОбъектRBAC_ПередУдалением__, посредством вызова метода __УправлениеДоступомRBAC.ТекущийПользовательИмеетДоступ__. Подписки сопоставлены с определяемым типом _ОпределяемыйТип.ОбъектRBAC_. Определение текущего пользователя производится на основе параметра сеанса __ТекущийПользовательRBAC__, который имеет тип _СправочникСсылка.ПользователиRBAC_ и должен устанавливаться в прикладном решении.

## Прочий функционал
Включение и отключение функционала производится установкой соответствующего значения константы __ИспользоватьRBAC__.

При отсутствии родителя или владельца у объекта доступа, может быть назначен корневой элемент по умолчанию, посредством установки соответствующего значения константы __КорневойОбъектRBAC__.

### Модель безопасности & роли
Предполагается, что библиотека используется совместно с классической ролевой моделью 1С:Предприятие. При этом, объектам, с использованием классических ролей назначаются максимально допустимые привилегии, а точная настройка производится средствами библиотеки.

Библиотека содержит нижеследующие роли:

| Роль | Описание |
|------|----------|
| ОбходПроверкиRBAC | Для членов этой роли проверка прав RBAC не осуществляется и доступ RBAC всегда разрешен |
| УстановкаРежимаИспользованияRBAC | Члены этой роли могут включать и отключать проверку доступа RBAC посредством установки соответствующего значения константы __ИспользоватьRBAC__ |
| НазначениеРолейRBAC | Члены этой роли могут назначать роли определенным пользователям и группам и привязывать их к соответствующим объектам |
| АдминистраторДоступаRBAC | Члены этой роли могут создавать роли, группы доступа, изменять членство в группах доступа, а также назначать роли |
| ЧтениеRBAC | Члены этой группы могут просматривать все объекты библиотеки |
| ИспользованиеПользовательскийИнтерфейсRBAC | Членам этой роли доступно отображение подсистемы __УправлениеДоступомRBACПользовательскийИнтерфейс__ в пользовательском интерфейсе |
| НеинтерактивнаяПолныеПраваRBAC | Члены этой роли имеют возможность неинтерактивно создавать/изменять/удалять любые объекты библиотеки |
| НеинтерактивнаяУправлениеПользователямиRBAC | Члены этой роли имеют неинтерактивный полный доступ к справочнику ПользователиRBAC |
| НеинтерактивнаяУправлениеГруппамиRBAC | Члены этой группы могут неинтерактивно создавать/изменять/удалять группы доступа за исключением встроенных, а также изменять их членство | 

## Внедрение
Внедрение осуществляется посредством сравнения/объединения конфигурационного файла библиотеки с целевой конфигурацией.

Необходимо выбрать Отметить по подсистемам файла.

## Добавление объекта для использования совместно с RBAC

- Для того, чтобы применить назначение роли к объекту, необходимо добавить его в состав определяемого типа __СсылкаОбъектRBAC__, а также включить его в состав общего реквизита __РодительскийОбъектRBAC__. 
- Для того, чтобы разрешения могли быть применены к объекту (мог быть проверен доступ к объекту), необходимо добавить соответствующие типы разрешений в справочник __ТипыРазрешенийRBAC__, добавить объект в состав определяемого типа __ОбъектRBAC__ (для выполнения подписок), добавить объект в состав общего реквизита __ТипРесурсаRBAC__ (чтобы знать тип объекта для определения прав).

Также, необходимо создать обработчик __ПередЗаписью__:

```go
Процедура ПередЗаписью(Отказ)
	// Установить тип объекта 
	УправлениеОбъектамиДоступаRBAC.УстановитьТипРесурса(ЭтотОбъект, "all/providername/resourcetype/action");
	// Другие действия 
	
КонецПроцедуры
```

